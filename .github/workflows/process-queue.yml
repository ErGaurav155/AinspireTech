# .github/workflows/process-queue.yml
name: Process Queue Hourly

on:
  schedule:
    # Runs at minute 0 of every hour (UTC)
    - cron: "0 * * * *"
  # Also run on manual trigger
  workflow_dispatch:

jobs:
  process-queue:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Queue Processing
        run: |
          RESPONSE=$(curl -s -X GET \
            "${{ secrets.APP_URI }}/api/public/process-queue" \
            -H "Authorization: Bearer ${{ secrets.CRON_TOKEN }}" \
            -H "Content-Type: application/json" \
            -w "\nHTTP Status: %{http_code}")

          echo "Response:"
          echo "$RESPONSE"

          # Extract HTTP status code
          HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP Status:" | cut -d' ' -f3)

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Error: Queue processing failed with status $HTTP_STATUS"
            exit 1
          fi

          echo "Queue processing triggered successfully"
        env:
          APP_URI: ${{ secrets.APP_URI }}
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
